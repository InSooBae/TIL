# ìŠ¤í•€ë½, ë®¤í…ìŠ¤, ì„¸ë§ˆí¬ì–´

Created Time: October 19, 2022 11:30 PM
Status: ğŸ›  In Progress

## ì–´ë–»ê²Œ Mutual Exclusionì„ ë³´ì¥í•  ìˆ˜ ìˆì„ê¹Œ?

ë½(lock)ì„ ì‚¬ìš©í•˜ì

```java
do {

	acquire lock
		critical section
	release lock
		remainder section

} while (true)
```

ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤/ì“°ë ˆë“œê°€ ë½ì„ íšë“í•˜ê¸° ìœ„í•´ì„œ ê²½í•©ì„ í•˜ê²Œ ë˜ëŠ”ë°, ê·¸ ì¤‘ ì„±ê³µí•œ í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤/ì“°ë ˆë“œê°€ `critical section`ì— ë“¤ì–´ê°€ì„œ ì‹¤í–‰ì„ í•˜ê²Œ ëœë‹¤.

í•´ë‹¹ ì‘ì—…ì´ ëë‚˜ë©´ `critical section`ì„ ë¹ ì ¸ë‚˜ì˜¤ë©´ì„œ ë½ì„ ë°˜í™˜í•œë‹¤.

```c
volatile int lock = 0; // global

int test_and_set(int* lockPtr);

void critical() {
	while (test_and_set(&lock) == 1);

	... critical section

	lock = 0;
}

// ì´ëŸ° ë¡œì§ ëŠë‚Œì´ì§€ ì‹¤ì œ ì½”ë“œ ì•„ë‹˜
int test_and_set(int* lockPtr) {
	int oldLock = *lockPtr;
	*lockPtr = 1;
	return oldLock;
}
```

2ê°œì˜ ì“°ë ˆë“œ T1, T2ê°€ ìˆë‹¤ê³  ê°€ì •í•˜ê³ , critical()ì„ ì‹¤í–‰í•œë‹¤.

`while (test_and_set(&lock) == 1);` T1ì´ ì‹¤í–‰ í›„ `lock`ì´ 1ì´ ëœ í›„ 0ì„ ë¦¬í„´í•˜ì—¬ while ë£¨í”„ë¥¼ íƒˆì¶œí•˜ê³  `critical section`ì— ì§„ì…í•œë‹¤.

ê·¸ ë‹¤ìŒ T2ê°€ ì‹¤í–‰ë˜ì–´ `while (test_and_set(&lock) == 1);` ì— ì§„ì…í•˜ë©´ 1ì—ì„œ 1ë¡œ ë°”ê¿”ì£¼ì–´ while ë£¨í”„ë¥¼ ê³„ì† test_and_setì„ í˜¸ì¶œí•˜ë©° ë°˜ë³µí•˜ê²Œ ëœë‹¤.

ê·¸ëŸ¬ë‹¤ê°€ T1ì˜ `criitical section`ì—ì„œ ì‘ì—…í•˜ë˜ ê²ƒì´ ì™„ë£Œ í›„ `lock=0` ìœ¼ë¡œ ë°”ê¿”ì£¼ì–´ T2ê°€ íƒˆì¶œí›„ ì§„í–‰í•˜ê²Œ ë  ê²ƒì´ë‹¤.

ì´ëŸ° ì‹ìœ¼ë¡œ `TestAndSet`ìœ¼ë¡œ ë™ì‹œì— `critical section`ì—ì„œëŠ” ì‹¤í–‰í•  ìˆ˜ ì—†ê²Œ ëœë‹¤.

ê·¸ëŸ°ë° ë™ì‹œì— `while (test_and_set(&lock) == 1);` ì— T1 T2ê°€ ì‹¤í–‰ì„ í•œë‹¤ë©´?

ë‘˜ ë‹¤ ì§„ì…í•  ìˆ˜ ìˆëŠ” ê²ƒì´ ì•„ë‹Œê°€?

ì´ë¥¼ ë°©ì§€ ê°€ëŠ¥í•˜ê²Œë” ì„¤ê³„ê°€ ë˜ì–´ìˆë‹¤.

CPUì˜ ë„ì›€ì„ ë°›ì•„ `TestAndSet`ì€ **CPU atomic** ëª…ë ¹ì–´ì´ë‹¤.

### CPU atomic

- ì‹¤í–‰ ì¤‘ê°„ì— ê°„ì„­ë°›ê±°ë‚˜ ì¤‘ë‹¨ë˜ì§€ ì•ŠëŠ”ë‹¤.
- ê°™ì€ ë©”ëª¨ë¦¬ ì˜ì˜ì— ëŒ€í•´ ë™ì‹œì— ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.
    - TestAndSetì˜ ë™ì¼í•œ íŒŒë¼ë¯¸í„°ì˜ ëŒ€í•´ì„œ ë‘ ê°œ ì´ìƒì˜ í”„ë¡œì„¸ìŠ¤/ì“°ë ˆë“œê°€ ë™ì‹œì— í˜¸ì¶œí•œë‹¤ í• ì§€ë¼ë„, CPU ë ˆë²¨ì—ì„œ ì•Œì•„ì„œ ë¨¼ì € í•˜ë‚˜ë¥¼ ì‹¤í–‰ì‹œí‚¤ê³  ê·¸ í•˜ë‚˜ê°€ ëë‚˜ë©´ ë‹¤ìŒì´ ì‹¤í–‰ë˜ëŠ” ì‹ìœ¼ë¡œ ë™ê¸°í™” ì‘ì—… ì²˜ë¦¬ë¥¼ í•¨(ë™ì‹œì— ì‹¤í–‰ X)

ë‹¤ì‹œ ì•„ê¹Œ ì˜ˆì œì˜ `while (test_and_set(&lock) == 1);` ë¥¼ ë³´ë©´ test_and_setì„ ì‹¤í–‰í•˜ê³  ìˆë‹¤ê°€, C-Sì´ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì´ë‹¤. (ë‹¤ë¥¸ ì“°ë ˆë“œê°€ ì‹¤í–‰ë  ì¼ì´ ì—†ìŒ) atomic í•˜ë‹¤.

ë‘ ê°œì˜ ì“°ë ˆë“œê°€ ë™ì‹œì— test_and_setì„ ì‹¤í–‰ì‹œí‚¤ë©´ ë™ì‹œì— ì‹¤í–‰ë˜ì§€ ì•Šê³  CPU ë ˆë²¨ì— ë‘˜ ì¤‘ì— í•˜ë‚˜ê°€ ì‹¤í–‰ë˜ê³ (ë¬´ì—‡ì´ ë¨¼ì €ì¸ì§€ëŠ” ëª¨ë¦„) ê·¸ í•˜ë‚˜ê°€ ëë‚˜ë©´ ë‹¤ìŒ í•˜ë‚˜ê°€ ì•Œì•„ì„œ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ ë™ê¸°í™”ë¥¼ ì‹œì¼œì„œ ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” ì¼ì´ ì—†ë„ë¡ í•œë‹¤.

## ìŠ¤í•€ë½(Spinlock)

ìœ„ ì˜ˆì œì²˜ëŸ¼ `while (test_and_set(&lock) == 1);` ë½ì„ ê³„ì† ì–»ìœ¼ë ¤ê³  ë°˜ë³µí•´ì„œ ì‹œë„í•˜ëŠ” ë°©ì‹ì´ ìŠ¤í•€ë½ì´ë‹¤.

í•˜ì§€ë§Œ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ CPUë¥¼ ë‚­ë¹„í•œë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤.

(ê³„ì† ë½ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì•¼í•˜ë‹ˆê¹Œ í™•ì¸í•˜ëŠ” ìì²´ê°€ CPU Cycleë¥¼ ì¡ì•„ë¨¹ìŒ)

í•´ê²°

ë½ì´ ì¤€ë¹„ë˜ë©´ ë‚˜ ê¹¨ì›Œì¤˜!! ê·¸ë•Œë™ì•ˆ ë‚˜ ìê³ ìˆì„ê²Œ!!

## ë®¤í…ìŠ¤(Mutex)

```cpp
class Mutex {
	int value = 1;
	int guard = 0;
}

void Mutex::lock() {

	while (test_and_set(&guard));

	if (value == 0) {
		... í˜„ì¬ ì“°ë ˆë“œë¥¼ íì— ë„£ìŒ
		guard = 0; & go to sleep;
	} else {
		value = 0;
		guard = 0;
	}
}

void Mutex::unlock() {

	while (test_and_set(&guard));

	if (íì— í•˜ë‚˜ë¼ë„ ëŒ€ê¸°ì¤‘ì´ë©´) {
		ê·¸ ì¤‘ì— í•˜ë‚˜ë¥¼ ê¹¨ìš´ë‹¤;
	} else {
		value = 1;
	}
	guard = 0;
}

int main() {
  Mutex mutex;
	///////////////////////
  mutex->lock();
	... critical section
	mutex->unlock();
	///////////////////////
  return 0;
}
```

ì—¬ê¸°ì„œë„ `critical section`ì— ë“¤ì–´ê°€ê¸° ìœ„í•´ ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤/ì“°ë ˆë“œê°€ ê²½í•©ì„ í•  ê²ƒì´ë‹¤.

ê·¸ë•Œ Mutexì˜ ë½ì„ ì–»ê¸° ìœ„í•´ ê²½í•©ì„ í•œë‹¤.

ê·¸ ì¤‘ í•˜ë‚˜ê°€ ë½ì„ ì–»ê²Œë˜ë©´ `critical section`ì— ë“¤ì–´ê°€ ì‘ì—…ì„ í•˜ê³  ë‚˜ì™€ì„œ ë½ì„ ë°˜í™˜í•œë‹¤.

ê·¸ëŸ¬ë ¤ë©´ `Mutex`ì˜ `value`ì˜ ê°’(0ì´ ì•„ë‹Œ ê°’)ì„ ì·¨ë“í•´ì•¼ë§Œ `critical section`ì— ë™ì‘í•  ìˆ˜ ìˆë‹¤.

```cpp
if (value == 0) {
		... í˜„ì¬ ì“°ë ˆë“œë¥¼ íì— ë„£ìŒ
		guard = 0; & go to sleep;
	} else {
		value = 0;
		guard = 0;
	}
```

ìœ„ ì½”ë“œ(lock ë©”ì„œë“œ)ì—ì„œ ë³´ë©´ ì´ë¯¸ `value`ë¥¼ ëˆ„ê°€ `ì´ë¯¸ ì·¨ë“í•œ ìƒíƒœ(valueê°€ 0)`ë¼ë©´, ë‹¤ìŒì— ìê¸° ì°¨ë¡€ê°€ ë˜ì–´ì„œ ë½ì„ ì·¨ë“í•  ìˆ˜ ìˆìœ¼ë©´ êº ì›Œ ë‹¬ë¼ê³  í•˜ê¸° ìœ„í•´ íì— ìê¸° ìì‹ ì„ ë„£ëŠ”ë‹¤.

ê·¸ê²Œ ì•„ë‹ˆë©´ `value`ë¥¼ ì·¨ë“í•˜ê³  `value`ë¥¼ `0`ìœ¼ë¡œ ë°”ê¾¼ë‹¤.

```cpp
if (íì— í•˜ë‚˜ë¼ë„ ëŒ€ê¸°ì¤‘ì´ë©´) {
		ê·¸ ì¤‘ì— í•˜ë‚˜ë¥¼ ê¹¨ìš´ë‹¤;
	} else {
		value = 1;
}
guard = 0;
```

ë‹¤ìŒ ì½”ë“œ(unlock ë©”ì„œë“œ)ë¥¼ ë³´ë©´

Mutexì˜ ë½ì„ í•´ì œí•  ë•Œ `íì— í•˜ë‚˜ë¼ë„ ëŒ€ê¸°ì¤‘ì¸ ê²ƒì´ ìˆë‹¤`ë©´, ê·¸ ì¤‘ í•˜ë‚˜ë¥¼ ê¹¨ìš´ë‹¤.

ê·¸ê²Œ ì•„ë‹ˆë©´ `value`ê°’ì„ ë‹¤ì‹œ `1`ë¡œ ë§Œë“¤ì–´ ë†“ëŠ”ë‹¤.

ê·¸ëŸ¼ `guard`ëŠ” ì™œ ìˆìŒ?

ì´ `value`ë¼ëŠ” ê°’ ìì²´ë„ ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤/ì“°ë ˆë“œê°€ ì„œë¡œ ì·¨ë“í•˜ë ¤ê³  ë…¸ë ¥í•˜ëŠ” ê³µìœ ë˜ëŠ” ë°ì´í„°ì´ë‹¤.

ê·¸ëŸ¬ë©´ ì´ `value` ë¼ëŠ” ê°’ ìì²´ë„, ê·¸ ê°’ì„ ë°”ê¿”ì¤„ ë•Œë§ˆë‹¤ `critical section`ì˜ì—­ ì•ˆì—ì„œ ì•ˆì „í•˜ê²Œ ë³´í˜¸ ë°›ìœ¼ë©´ì„œ ê°’ì„ ë°”ê¿”ì¤˜ì•¼í•œë‹¤.

ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤/ì“°ë ˆë“œê°€ ë™ì‹œì— ì ‘ê·¼í•˜ê³  ìˆê¸° ë•Œë¬¸ì— `race condition`ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

ê·¸ë˜ì„œ `lock(), unlock()` ì—ì„œ `while (test_and_set(&guard));` ì´ ì½”ë“œê°€ ì‹¤í–‰ì´ ëœë‹¤.

`value` ê°’ì„ ë°”ê¿”ì£¼ëŠ” ì‘ì—…ì„ í•˜ê¸° ì „ì— ì´ `guard`ë¼ëŠ” ê°’ì„ ì·¨ë“í•˜ê¸° ìœ„í•´ì„œ ì„œë¡œ ê²½í•©ì„ í•˜ê²Œ ë˜ê³ , ê·¸ ì¤‘ ë‹¨ í•˜ë‚˜ê°€ ì·¨ë“ì„ í•˜ê²Œ ë˜ë©´ value ê°’ì„ ë¹„ê¿”ì£¼ëŠ” ë¡œì§ì„ ìˆ˜í–‰í•˜ê²Œ ëœë‹¤.

í•´ë‹¹ ì‘ì—… ì™„ë£Œí›„ `guard` ê°’ì„ `0`ìœ¼ë¡œ ë°”ê¿”ì£¼ê³  ë‹¤ìŒ ì‘ì—…ì´ ì‹¤í–‰ëœë‹¤.

ëŒ€ëµì ìœ¼ë¡œ ëŠë‚Œì€

1. ë½ì„ ì¥˜ ìˆ˜ ì—†ìœ¼ë©´ íì— ëŒ€ê¸°í•˜ì—¬ ë‚˜ì¤‘ì— ê¹¨ì›Œë‹¬ë¼ê³  í•œë‹¤.
    1. ê·¸ë˜ì„œ CPU ì‹¸ì´í´ì„ ë¶ˆí•„ìš”í•˜ê²Œ ë‚­ë¹„í•˜ëŠ” ê²ƒì„ ìµœì†Œí™” ì‹œí‚¨ë‹¤.
2. CPU ë ˆë²¨ì—ì„œ ì§€ì›í•˜ëŠ” atomicí•œ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤.
    1. `test_and_set()`ìœ¼ë¡œ atomicí•œ ëª…ë ¹ì–´ ì´ìš©
    

ê·¸ë˜ì„œ ë®¤í…ìŠ¤ëŠ” **ë½ì„ ê°€ì§ˆ ìˆ˜ ìˆì„ ë•Œ ê¹Œì§€ íœ´ì‹**ì„ ì·¨í•˜ëŠ” ë°©ì‹ì´ë‹¤.

### ê·¸ëŸ¬ë©´ ë®¤í…ìŠ¤ê°€ ìŠ¤í•€ë½ë³´ë‹¤ í•­ìƒ ì¢‹ì€ê°€?

ê¼­ ê·¸ë ‡ì§€ë§Œì€ ì•Šë‹¤.

**ë©€í‹° ì½”ì–´** í™˜ê²½,

**critical sectionì—ì„œì˜ ì‘ì—…ì´ C-Së³´ë‹¤ ë” ë¹¨ë¦¬ ëë‚œë‹¤**ë©´

**ìŠ¤í•€ë½**ì´ **ë®¤í…ìŠ¤ë³´ë‹¤ ë” ì´ì **ì´ ìˆë‹¤.

ê°‘ìê¸° ì™  C-Së³´ë‹¤ ë” ë¹¨ë¦¬ ëë‚˜ì•¼í•˜ëƒ?

ë®¤í…ìŠ¤ ê°™ì€ ê²½ìš° ë½ì„ ì·¨ë“í•  ìˆ˜ ì—†ìœ¼ë©´ ì¼ë‹¨ ì ë“¤ì–´ ìˆë‹¤ ë‚˜ì¤‘ì— ê¹¨ì›Œì¤˜ì•¼ í•œë‹¤.

ê·¸ë•Œ ì ë“¤ê³  ê¹¨ëŠ” ê³¼ì •(ë‹¤ë¥¸ ì“°ë ˆë“œê°€ CPU ì„ ì )ì— C-Sì´ ë°œìƒì„ í•œë‹¤.

ìŠ¤í•€ë½ ê°™ì€ ê²½ìš° ì ë“¤ê³  ìì‹œê³ , ë‚´ê°€ ë½ì„ ì·¨ë“í•  ë•Œ ê¹Œì§€ í™•ì¸í•˜ë©´ì„œ ìˆëŠ”ë‹¤.

ì´ë•Œ `critical section` ì‘ì—…ì´ **ë¹¨ë¦¬ ëë‚œë‹¤ë©´** ê³„ì† whileíƒ€ë©´ì„œ ëŒ€ê¸°í•˜ëŠ” **ìŠ¤í•€ë½**ì´ íì— ë“¤ì–´ê°€ê³  ë‚˜ì˜¤ë©´ì„œ C-Sì´ ì¼ì–´ë‚˜ëŠ” **ë®¤í…ìŠ¤**ë³´ë‹¤ ë” ì´ì ì´ ìˆë‹¤.

ê·¸ëŸ¼ ë˜ ì™œ **ë©€í‹° ì½”ì–´** í™˜ê²½ì´ì–´ì•¼?

ì‹±ê¸€ì½”ì–´ì—ì„œ ìƒê°ì„ í•´ë³´ë©´ ìŠ¤í•€ë½ ë°©ì‹ìœ¼ë¡œ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤ í•´ë„, ë½ì„ ì·¨ë“ì„ í•˜ë ¤ë©´ ë³¸ì¸ ì œì™¸ ëˆ„êµ°ê°€ê°€ ë½ì„ í’€ì–´ì¤˜ì•¼ í•˜ëŠ”ë°

ì˜ˆë¥¼ ë“¤ì–´ T1ì´ critical sectionì—ì„œ ì‘ì—… ëë‚œ í›„ lockë°”ê¾¸ê³  ë‚˜ë©´ ì‹±ê¸€ì½”ì–´ë¼ ê²°êµ­ C-Sì´ ì¼ì–´ë‚˜ì„œ ì˜¤íˆë ¤ ì“¸ë°ì—†ì´ ë°˜ë³µë¬¸ë§Œ ë” ëŒì•„ ì´ì ì´ ì „í˜€ ì—†ë‹¤.

ê·¼ë° ë©€í‹° ì½”ì–´ì—ì„œëŠ” T1ì´ critical sectionì´ ëë‚˜ê³  ë½ì„ ë°˜ë‚©í•˜ë©´ ë‹¤ë¥¸ ì½”ì–´ì—ì„œ ë°˜ë³µë¬¸ìœ¼ë¡œ ëŒë©´ì„œ ë½ì„ ì–»ê¸°ë§Œì„ ê¸°ë‹¤ë¦¬ë˜ T2ê°€ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ê°€ ì„±ë¦½ëœë‹¤.

ì´ëŸ° ê²½ìš°ì²˜ëŸ¼ ìŠ¤í•€ë½ì´ ë™ì‘í•˜ë©´ C-Sê°€ ë™ì‘í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë” ì´ì ì´ ìˆì„ ìˆ˜ ìˆëŠ” ê²ƒì´ë‹¤.

## ì„¸ë§ˆí¬ì–´(Semaphore)

signal mechanismì„ ê°€ì§„, í•˜ë‚˜ ì´ìƒì˜ í”„ë¡œì„¸ìŠ¤/ì“°ë ˆë“œê°€ ciritical sectionì— ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ í•˜ëŠ” ì¥ì¹˜

```cpp
class Semaphore {
	int value = 1;
	int guard = 0;
}

void Semaphore::wait() {

	while (test_and_set(&guard));

	if (value == 0) {
		... í˜„ì¬ ì“°ë ˆë“œë¥¼ íì— ë„£ìŒ
		guard = 0; & go to sleep;
	} else {
		value -= 1;
		guard = 0;
	}
}

void Semaphore::signal() {

	while (test_and_set(&guard));

	if (íì— í•˜ë‚˜ë¼ë„ ëŒ€ê¸°ì¤‘ì´ë©´) {
		ê·¸ ì¤‘ì— í•˜ë‚˜ë¥¼ ê¹¨ì›Œì„œ ì¤€ë¹„ ì‹œí‚¨ë‹¤;
	} else {
		value += 1;
	}
	guard = 0;
}

int main() {
  Mutex mutex;
	///////////////////////
  mutex->wait();
	... critical section
	mutex->signal();
	///////////////////////
  return 0;
}
```